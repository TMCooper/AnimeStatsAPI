<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeStats: Community Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        secondary: '#ec4899',
                        accent: '#06b6d4',
                        dark: '#0f172a',
                        surface: '#1e293b',
                        gold: '#fbbf24',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
            background-attachment: fixed;
        }

        .glass {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .glass-strong {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 8px 40px rgba(139, 92, 246, 0.15);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 4px;
        }

        .animate-enter {
            animation: enter 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes enter {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px rgba(139, 92, 246, 0.2);
        }

        .hero-gradient {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(139, 92, 246, 0.6);
            }
        }
    </style>
</head>

<body class="text-gray-200 min-h-screen flex flex-col selection:bg-primary selection:text-white">

    <!-- Enhanced Top Bar -->
    <nav class="glass-strong sticky top-0 z-50 border-b border-primary/20 mb-8">
        <div class="max-w-[1800px] mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary via-secondary to-accent flex items-center justify-center text-white font-bold shadow-lg pulse-glow">
                            <i class="fa-solid fa-server text-xl"></i>
                        </div>
                        <div
                            class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-dark animate-pulse">
                        </div>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black tracking-tight text-white">
                            ANIME<span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">STATS</span>
                            API
                        </h1>
                        <p class="text-[10px] text-gray-400 font-mono uppercase tracking-wider">Community Database
                            Explorer</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="hidden md:flex items-center gap-4">
                        <div class="glass px-4 py-2 rounded-lg">
                            <p class="text-[10px] text-gray-500 uppercase">System Status</p>
                            <p class="text-sm font-bold text-accent" id="statusText">INITIALIZING...</p>
                        </div>
                        <div class="glass px-4 py-2 rounded-lg">
                            <p class="text-[10px] text-gray-500 uppercase">Data Points</p>
                            <p class="text-sm font-bold text-primary" id="dataPoints">0</p>
                        </div>
                    </div>
                    <button onclick="hardReset()"
                        class="px-4 py-2 bg-red-500/10 border border-red-500/30 text-red-400 hover:bg-red-500/20 transition rounded-lg text-xs font-bold uppercase tracking-wider">
                        <i class="fa-solid fa-trash-arrow-up mr-2"></i> Purge Cache
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-[1800px] mx-auto px-6 space-y-8 flex-grow">

        <!-- LOADING SCREEN -->
        <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="relative mb-8">
                <div
                    class="w-24 h-24 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center shadow-2xl pulse-glow">
                    <i class="fa-solid fa-brain-circuit text-4xl text-white animate-pulse"></i>
                </div>
                <div class="absolute -top-2 -right-2 w-6 h-6 bg-accent rounded-full animate-ping"></div>
            </div>
            <h2 class="text-4xl font-black text-white mb-2 tracking-tight">GREMORY ARCHIVE SYSTEM</h2>
            <p class="text-gray-400 font-mono text-sm mb-8" id="loadingText">Initializing crimson database...</p>

            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="glass-strong p-6 rounded-xl text-center">
                    <i class="fa-solid fa-database text-3xl text-primary mb-2"></i>
                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">Titres Analysés</p>
                    <p class="text-3xl font-black text-white" id="loadingTitles">0</p>
                </div>
                <div class="glass-strong p-6 rounded-xl text-center">
                    <i class="fa-solid fa-satellite-dish text-3xl text-accent mb-2"></i>
                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">API Calls</p>
                    <p class="text-3xl font-black text-white" id="loadingCalls">0</p>
                </div>
                <div class="glass-strong p-6 rounded-xl text-center">
                    <i class="fa-solid fa-bolt text-3xl text-green-400 mb-2"></i>
                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">Cache Hits</p>
                    <p class="text-3xl font-black text-white" id="loadingCache">0</p>
                </div>
            </div>

            <div class="w-[600px] h-3 bg-gray-800 rounded-full overflow-hidden shadow-inner">
                <div id="progressBar"
                    class="h-full bg-gradient-to-r from-primary via-accent to-secondary w-0 transition-all duration-300 shadow-lg">
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-3 font-mono"><span id="loadingPercent">0</span>% • <span
                    id="loadingETA">Calculating ETA...</span></p>
        </div>

        <!-- MAIN DASHBOARD -->
        <div id="dashboard" class="hidden animate-enter space-y-8">

            <!-- HERO STATS -->
            <div class="hero-gradient rounded-2xl p-8 mb-8">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                    <div class="text-center">
                        <i class="fa-solid fa-folder-open text-3xl text-primary mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Total Fichiers</p>
                        <h3 class="text-3xl font-black text-white mt-1" id="totalFiles">0</h3>
                    </div>
                    <div class="text-center">
                        <i class="fa-solid fa-film text-3xl text-accent mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Titres Uniques</p>
                        <h3 class="text-3xl font-black text-white mt-1" id="uniqueTitles">0</h3>
                    </div>
                    <div class="text-center">
                        <i class="fa-solid fa-stopwatch text-3xl text-secondary mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Temps Perdu</p>
                        <h3 class="text-lg font-black text-white mt-3 leading-none" id="timeWasted">0j 0h</h3>
                    </div>
                    <div class="text-center">
                        <i class="fa-solid fa-star text-3xl text-yellow-400 mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Note Moy.</p>
                        <h3 class="text-3xl font-black text-white mt-1" id="avgScore">0.0</h3>
                    </div>
                    <div class="text-center">
                        <i class="fa-solid fa-masks-theater text-3xl text-green-400 mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Genres</p>
                        <h3 class="text-3xl font-black text-white mt-1" id="totalGenres">0</h3>
                    </div>
                    <div class="text-center">
                        <i class="fa-solid fa-calendar-check text-3xl text-blue-400 mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Jours Actifs</p>
                        <h3 class="text-3xl font-black text-white mt-1" id="activeDays">0</h3>
                    </div>
                    <div class="text-center">
                        <i class="fa-solid fa-hourglass-half text-3xl text-purple-400 mb-2"></i>
                        <p class="text-xs text-gray-400 uppercase font-bold">Âge Collection</p>
                        <h3 class="text-3xl font-black text-white mt-1" id="ageSpan">0</h3>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Oldest Anime -->
                <div class="glass-strong rounded-2xl p-6 border-l-4 border-blue-500">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-scroll text-blue-400"></i> L'Ancêtre de la Collection
                    </h3>
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0">
                            <img id="oldestImage" src="" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-white mb-1" id="oldestTitle">--</h4>
                            <p class="text-sm text-blue-400 mb-1" id="oldestYear">Année: --</p>
                            <p class="text-xs text-gray-500" id="oldestStudio">Studio: --</p>
                        </div>
                    </div>
                </div>

                <!-- Newest Anime -->
                <div class="glass-strong rounded-2xl p-6 border-l-4 border-green-500">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-sparkles text-green-400"></i> La Nouvelle Recrue (Sortie)
                    </h3>
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0">
                            <img id="newestImage" src="" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-white mb-1" id="newestTitle">--</h4>
                            <p class="text-sm text-green-400 mb-1" id="newestYear">Année: --</p>
                            <p class="text-xs text-gray-500" id="newestStudio">Studio: --</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: YEAR DISTRIBUTION -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-timeline text-purple-400"></i> Distribution par Décennie
                    </h3>
                    <div class="h-[300px]">
                        <canvas id="decadeChart"></canvas>
                    </div>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-calendar-days text-orange-400"></i> Timeline Annuelle (10
                        dernières
                        années)
                    </h3>
                    <div class="h-[300px]">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: TOP PERFORMERS -->
            <h2 class="text-2xl font-black text-white pl-4 border-l-4 border-primary flex items-center gap-3">
                <i class="fa-solid fa-trophy"></i> TOP PERFORMERS
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Top Downloads -->
                <div class="glass rounded-2xl p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-fire text-orange-500"></i> Les "Hits" de la Communauté
                        </h3>
                        <span class="text-xs text-gray-500 font-mono">Volume de fichiers</span>
                    </div>
                    <div class="h-[300px]">
                        <canvas id="topDownloadsChart"></canvas>
                    </div>
                </div>

                <!-- Summary KPI -->
                <div class="grid grid-cols-1 gap-4">
                    <div class="glass p-6 rounded-2xl border-l-4 border-primary">
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Titre le plus stocké
                        </p>
                        <h3 class="text-xl font-black text-white mt-1 truncate" id="topTitle">--</h3>
                        <p class="text-sm text-primary mt-1" id="topTitleCount">0 fichiers</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-accent">
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Studio Dominant</p>
                        <h3 class="text-xl font-black text-white mt-1" id="topStudio">--</h3>
                        <p class="text-sm text-accent mt-1" id="topStudioCount">0 séries</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-secondary">
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Genre Favori</p>
                        <h3 class="text-xl font-black text-white mt-1" id="topGenre">--</h3>
                        <p class="text-sm text-secondary mt-1" id="topGenreCount">--</p>
                    </div>
                </div>
            </div>

            <!-- SECTION: TEMPORAL ANALYSIS -->
            <h2 class="text-2xl font-black text-white pl-4 border-l-4 border-accent flex items-center gap-3">
                <i class="fa-solid fa-chart-line"></i> ANALYSE TEMPORELLE
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Daily Activity -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-calendar-days text-green-400"></i> Activité Quotidienne (30
                        derniers
                        jours)
                    </h3>
                    <div class="h-[250px]">
                        <canvas id="dailyActivityChart"></canvas>
                    </div>
                </div>

                <!-- Hourly Heatmap -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-clock text-blue-400"></i> Distribution Horaire
                    </h3>
                    <div class="h-[250px]">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: INDUSTRY ANALYSIS -->
            <h2 class="text-2xl font-black text-white pl-4 border-l-4 border-primary flex items-center gap-3">
                <i class="fa-solid fa-industry"></i> ANALYSE DE L'INDUSTRIE
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Studio Volume -->
                <div class="glass rounded-2xl p-6 lg:col-span-2">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-building text-blue-400"></i> Influence des Studios (Volume)
                    </h3>
                    <div class="h-[250px]">
                        <canvas id="studioVolumeChart"></canvas>
                    </div>
                </div>

                <!-- Demographics -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-users text-green-400"></i> Cible Démographique
                    </h3>
                    <div class="h-[200px] flex justify-center">
                        <canvas id="demographicsChart"></canvas>
                    </div>
                </div>

                <!-- Source Material -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-book-open text-yellow-500"></i> Origine de l'Oeuvre
                    </h3>
                    <div class="h-[200px] flex justify-center">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: GENRE DEEP DIVE -->
            <h2 class="text-2xl font-black text-white pl-4 border-l-4 border-secondary flex items-center gap-3">
                <i class="fa-solid fa-masks-theater"></i> ANALYSE DES GENRES
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Genre Spectrum (Radar Chart) -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 text-center">Spectre des Genres
                    </h3>
                    <div class="h-[300px] flex justify-center">
                        <canvas id="genrePolarChart"></canvas>
                    </div>
                </div>

                <!-- Genre by Files -->
                <div class="glass rounded-2xl p-6 lg:col-span-2">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4">Genres par Volume de Fichiers
                    </h3>
                    <div class="h-[300px]">
                        <canvas id="genreFilesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: QUALITY METRICS -->
            <h2 class="text-2xl font-black text-white pl-4 border-l-4 border-yellow-500 flex items-center gap-3">
                <i class="fa-solid fa-star"></i> MÉTRIQUES DE QUALITÉ
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Score Distribution -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-star text-yellow-400"></i> Distribution des Notes
                    </h3>
                    <div class="h-[250px]">
                        <canvas id="scoreDistChart"></canvas>
                    </div>
                </div>

                <!-- Score vs Files Scatter -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-scatter text-purple-400"></i> Qualité vs Popularité
                    </h3>
                    <div class="h-[250px]">
                        <canvas id="scatterChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: DETAILED TABLE -->
            <h2 class="text-2xl font-black text-white pl-4 border-l-4 border-accent flex items-center gap-3">
                <i class="fa-solid fa-table"></i> CLASSEMENT DÉTAILLÉ
            </h2>
            <div class="glass rounded-2xl p-0 overflow-hidden flex flex-col max-h-[500px]">
                <div
                    class="p-4 border-b border-gray-700/50 bg-surface/50 flex justify-between items-center sticky top-0 z-10 backdrop-blur">
                    <h3 class="text-sm font-bold uppercase text-gray-300">
                        <i class="fa-solid fa-list-ol mr-2"></i> Classement Complet
                    </h3>
                    <div class="flex gap-2 text-[10px]">
                        <button onclick="renderTable('files')" id="btnFiles"
                            class="px-3 py-1 bg-primary text-white rounded">Téléchargements</button>
                        <button onclick="renderTable('score')" id="btnScore"
                            class="px-3 py-1 bg-surface border border-gray-600 text-gray-300 rounded hover:bg-gray-700">Qualité</button>
                    </div>
                </div>
                <div class="overflow-y-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-darker text-xs uppercase text-gray-500 sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-3">Rang</th>
                                <th class="px-6 py-3">Titre</th>
                                <th class="px-6 py-3">Année</th>
                                <th class="px-6 py-3">Studio</th>
                                <th class="px-6 py-3">Genre</th>
                                <th class="px-6 py-3 text-right">Fichiers</th>
                                <th class="px-6 py-3 text-right">Note</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody" class="divide-y divide-gray-800/30">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER -->
    <footer class="text-center text-gray-500 text-xs py-8 border-t border-gray-800/50 mt-12 bg-darker/50">
        <div class="space-y-2">
            <p>
                Powered by
                <a href="https://jikan.moe" target="_blank" class="text-primary hover:text-white transition">Jikan
                    API</a>
                &
                <a href="https://myanimelist.net" target="_blank"
                    class="text-blue-400 hover:text-white transition">MyAnimeList</a>
            </p>
            <p class="font-mono">
                Source Code available on
                <a href="https://github.com/TMCooper/AnimeStatsAPI" target="_blank"
                    class="text-white font-bold hover:text-accent transition">
                    <i class="fa-brands fa-github"></i> GitHub
                </a>
            </p>
            <p class="text-[10px] text-gray-600">AnimeStats API v1.0 • Designed for Community Archiving</p>
        </div>
    </footer>

    <script>
        const TOKEN = "{{ token }}";
        let library = [];
        let rawData = [];
        let chartInstances = {};

        // Image par défaut
        const DEFAULT_IMG = "https://placehold.co/400x600/1e293b/white?text=No+Image";

        const sleep = ms => new Promise(r => setTimeout(r, ms));

        function hardReset() {
            if (confirm("⚠️ Effacer tout le cache local et recharger ?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function similarity(a, b) {
            a = a.toLowerCase();
            b = b.toLowerCase();
            const longer = a.length > b.length ? a : b;
            const shorter = a.length > b.length ? b : a;

            const longerLength = longer.length;
            if (longerLength === 0) return 1.0;

            let same = 0;
            for (let i = 0; i < shorter.length; i++) {
                if (longer[i] === shorter[i]) same++;
            }
            return same / longerLength;
        }

        // --- PARSING AMÉLIORÉ ---
        function parseSeasonInfo(val) {
            const str = String(val).toLowerCase();
            let info = { num: 1, isRemake: false, isMovie: false };

            if (!val) return info;

            if (str.includes('film') || str.includes('movie') || str.includes('oav')) {
                info.isMovie = true;
                return info;
            }

            if (str.includes('remake')) {
                info.isRemake = true;
                const match = str.match(/saison\s*(\d+)/) || str.match(/s(\d+)/);
                if (match) info.num = parseInt(match[1]);
                return info;
            }

            const match = str.match(/\d+/);
            if (match) info.num = parseInt(match[0]);
            
            return info;
        }

        async function smartFetchMetadata(title, dbInfo) { 
            let cleanTitle = title.toLowerCase()
                .replace(/remake\d*/g, '')
                .replace(/saison\s*\d+/g, '')
                .replace(/season\s*\d+/g, '')
                .replace(/film/g, '')
                .replace(/movie/g, '')
                .replace(/s\d+/g, '')
                .replace(/[\[\(].*?[\]\)]/g, '')
                .replace(/\.(mkv|mp4|avi)/g, '')
                .replace(/_/g, ' ')
                .trim();

            const cacheKey = `trends_v23_${cleanTitle}_${dbInfo.isMovie ? 'M' : 'TV'}_${dbInfo.isRemake ? 'R' : ''}_s${dbInfo.num}`; 
            const cached = localStorage.getItem(cacheKey);

            if (cached) {
                const el = document.getElementById('loadingCache');
                if(el) el.innerText = parseInt(el.innerText || 0) + 1;
                return JSON.parse(cached);
            }

            try {
                await sleep(400 + Math.random() * 200);
                const el = document.getElementById('loadingCalls');
                if(el) el.innerText = parseInt(el.innerText || 0) + 1;

                const res = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(cleanTitle)}&limit=25`);

                if (res.status === 429) {
                    await sleep(3000); 
                    return smartFetchMetadata(title, dbInfo);
                }

                const json = await res.json();

                if (json.data && json.data.length > 0) {
                    let candidates = json.data;

                    // Filtre Type
                    if (dbInfo.isMovie) {
                        candidates = candidates.filter(x => x.type === 'Movie' || x.type === 'ONA');
                    } else {
                        candidates = candidates.filter(x => x.type === 'TV' || x.type === 'ONA');
                    }

                    // Filtre Statut (Pas de futur)
                    candidates = candidates.filter(x => x.status !== 'Not yet aired');

                    // Filtre Pertinence
                    candidates = candidates.filter(x => {
                        const titles = [
                            x.title,
                            x.title_english,
                            ...(x.titles || []).map(t => t.title)
                        ].filter(Boolean).map(t => t.toLowerCase());

                        // Match exact "Kaoru Hana wa Rin to Saku"
                        if (titles.includes(cleanTitle)) return true;

                        // Match strict : >= 75% similarité
                        return titles.some(t => similarity(t, cleanTitle) >= 0.75);
                    });

                    if (candidates.length === 0) return createFallback(title, dbInfo);

                    // Tri Année
                    candidates.sort((a, b) => {
                        const yearA = a.year || (a.aired?.from ? new Date(a.aired.from).getFullYear() : 0);
                        const yearB = b.year || (b.aired?.from ? new Date(b.aired.from).getFullYear() : 0);
                        return yearA - yearB; 
                    });

                    let bestMatch = null;

                    if (dbInfo.isRemake) {
                        bestMatch = candidates[candidates.length - 1];
                    } else if (dbInfo.isMovie) {
                        bestMatch = candidates[0];
                    } else {
                        const idx = dbInfo.num - 1;
                        if (idx < candidates.length) {
                            bestMatch = candidates[idx];
                        } else {
                            bestMatch = candidates[candidates.length - 1];
                        }
                    }

                    if (!bestMatch) return createFallback(title, dbInfo);

                    const imgUrl = bestMatch.images?.webp?.large_image_url || bestMatch.images?.jpg?.large_image_url || DEFAULT_IMG;
                    
                    let demos = bestMatch.demographics.map(d => d.name);
                    if (demos.length === 0 && bestMatch.genres) {
                        const known = ['Shounen', 'Seinen', 'Shoujo', 'Josei', 'Kids'];
                        bestMatch.genres.forEach(g => { if(known.includes(g.name)) demos.push(g.name); });
                    }

                    const meta = {
                        title: bestMatch.title,
                        title_en: bestMatch.title_english || bestMatch.title,
                        image: imgUrl,
                        score: bestMatch.score,
                        studios: bestMatch.studios.map(s => s.name),
                        genres: bestMatch.genres.map(g => g.name),
                        demographics: demos,
                        source: bestMatch.source,
                        year: bestMatch.year || (bestMatch.aired?.from ? new Date(bestMatch.aired.from).getFullYear() : null),
                        db_season_disp: dbInfo.isMovie ? "Film" : (dbInfo.isRemake ? "Remake" : `Saison ${dbInfo.num}`),
                        episodes: bestMatch.episodes || (dbInfo.isMovie ? 1 : 12),
                        url: bestMatch.url,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem(cacheKey, JSON.stringify(meta));
                    return meta;
                }
            } catch (e) { console.warn(e); }

            return createFallback(title, dbInfo);
        }

        function createFallback(title, dbInfo) {
            return {
                title_en: title,
                image: DEFAULT_IMG,
                year: null,
                studios: [], genres: [], demographics: [],
                score: 0,
                local_files: 0,
                db_season_disp: dbInfo.isMovie ? "Film" : `Saison ${dbInfo.num}`,
                episodes: dbInfo.isMovie ? 1 : 12,
                url: '#'
            };
        }

        async function init() {
            const pBar = document.getElementById('progressBar');
            const lText = document.getElementById('loadingText');
            const lPercent = document.getElementById('loadingPercent');
            const lTitles = document.getElementById('loadingTitles');
            const lETA = document.getElementById('loadingETA');
            const startTime = Date.now();

            try {
                lText.innerText = 'Connecting...';
                const res = await fetch(`/api/getStats`, { headers: { 'X-Admin-Token': TOKEN } });
                if (!res.ok) throw new Error("API Fetch failed");
                rawData = await res.json();

                lText.innerText = 'Processing local database...';
                const localMap = {};
                
                rawData.forEach(row => {
                    const title = row[1];
                    const seasonRaw = row[2];
                    const info = parseSeasonInfo(seasonRaw);
                    const ts = row[5];
                    const uniqueKey = `${title}_${info.isMovie}_${info.isRemake}_${info.num}`; 

                    if (!localMap[uniqueKey]) {
                        localMap[uniqueKey] = { title, dbInfo: info, count: 0, first_ts: ts, dates: [] };
                    }
                    localMap[uniqueKey].count++;
                    localMap[uniqueKey].dates.push({ date: row[4], timestamp: ts });
                    if (ts < localMap[uniqueKey].first_ts) localMap[uniqueKey].first_ts = ts;
                });

                const entries = Object.values(localMap);
                let tempLibrary = []; 
                let processed = 0;

                for (const entry of entries) {
                    lText.innerText = `Analyzing: ${entry.title}...`;
                    lTitles.innerText = processed + 1;
                    
                    const meta = await smartFetchMetadata(entry.title, entry.dbInfo); 
                    
                    tempLibrary.push({
                        ...meta,
                        local_files: entry.count,
                        dates: entry.dates,
                        first_seen: entry.first_ts
                    });
                    processed++;
                    pBar.style.width = `${Math.round((processed / entries.length) * 100)}%`;
                    lPercent.innerText = Math.round((processed / entries.length) * 100);
                }

                // CONSOLIDATION
                const consolidatedMap = {};
                tempLibrary.forEach(item => {
                    const key = `${item.title_en}_${item.db_season_disp}`;
                    if (consolidatedMap[key]) {
                        consolidatedMap[key].local_files += item.local_files;
                        consolidatedMap[key].dates = consolidatedMap[key].dates.concat(item.dates);
                        if (item.first_seen < consolidatedMap[key].first_seen) consolidatedMap[key].first_seen = item.first_seen;
                    } else {
                        consolidatedMap[key] = item;
                    }
                });
                library = Object.values(consolidatedMap);

                // --- UI DISPLAY ---
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                document.getElementById('statusText').innerText = "ONLINE";
                document.getElementById('dataPoints').innerText = library.length;
                document.getElementById('uniqueTitles').innerText = library.length;
                document.getElementById('totalFiles').innerText = library.reduce((acc, cur) => acc + cur.local_files, 0);

                // --- RESTORED: TOP PERFORMERS LOGIC ---
                
                // 1. Top Title (Most Files)
                const topFileTitle = [...library].sort((a, b) => b.local_files - a.local_files)[0];
                if (topFileTitle) {
                    document.getElementById('topTitle').innerText = topFileTitle.title_en;
                    document.getElementById('topTitleCount').innerText = `${topFileTitle.local_files} fichiers`;
                }

                // 2. Top Studio (Most Series)
                const studioStats = {};
                library.forEach(i => {
                    if (i.studios && i.studios.length > 0) {
                        i.studios.forEach(s => {
                            if (!studioStats[s]) studioStats[s] = 0;
                            studioStats[s]++;
                        });
                    }
                });
                const topStudioEntry = Object.entries(studioStats).sort((a, b) => b[1] - a[1])[0];
                if (topStudioEntry) {
                    document.getElementById('topStudio').innerText = topStudioEntry[0];
                    document.getElementById('topStudioCount').innerText = `${topStudioEntry[1]} séries`;
                }

                // 3. Top Genre (Most Titles)
                const genreStats = {};
                library.forEach(i => {
                    if (i.genres && i.genres.length > 0) {
                        i.genres.forEach(g => {
                            genreStats[g] = (genreStats[g] || 0) + 1;
                        });
                    }
                });
                const topGenreEntry = Object.entries(genreStats).sort((a, b) => b[1] - a[1])[0];
                if (topGenreEntry) {
                    document.getElementById('topGenre').innerText = topGenreEntry[0];
                    document.getElementById('topGenreCount').innerText = `${topGenreEntry[1]} titres`;
                }
                // --------------------------------------

                // Time Wasted
                const totalMinutes = library.reduce((acc, item) => acc + (item.episodes * 24), 0);
                const d = Math.floor(totalMinutes / 1440);
                const h = Math.floor((totalMinutes % 1440) / 60);
                document.getElementById('timeWasted').innerText = `${d}j ${h}h`;

                // Avg Score
                const scores = library.filter(i => i.score > 0);
                const avg = scores.length ? (scores.reduce((a, b) => a + b.score, 0) / scores.length).toFixed(2) : "0.0";
                document.getElementById('avgScore').innerText = avg;

                // Active Days / Age
                const allDates = new Set();
                let minTs = Infinity, maxTs = 0;
                library.forEach(i => {
                    i.dates.forEach(d => {
                        allDates.add(d.date);
                        if(d.timestamp < minTs) minTs = d.timestamp;
                        if(d.timestamp > maxTs) maxTs = d.timestamp;
                    });
                });
                document.getElementById('activeDays').innerText = allDates.size;
                document.getElementById('ageSpan').innerText = (maxTs > 0 && minTs < Infinity) ? `${Math.floor((maxTs - minTs) / 86400)}j` : "0j";

                // Total Genres
                document.getElementById('totalGenres').innerText = Object.keys(genreStats).length;

                // Oldest/Newest
                const withYear = library.filter(i => i.year && i.year > 1900);
                if (withYear.length > 0) {
                    const oldest = [...withYear].sort((a, b) => a.year - b.year)[0];
                    const newest = [...withYear].sort((a, b) => b.year - a.year)[0];
                    
                    if(oldest) updateHeroCard('oldest', oldest);
                    if(newest) updateHeroCard('newest', newest);
                }

                renderCharts();
                renderTable('files');

            } catch (e) {
                console.error('Error:', e);
                document.getElementById('loadingText').innerHTML = 'System Error. Check console.';
            }
        }

        function updateHeroCard(prefix, item) {
            document.getElementById(`${prefix}Title`).innerText = item.title_en;
            document.getElementById(`${prefix}Year`).innerText = `Année: ${item.year}`;
            document.getElementById(`${prefix}Studio`).innerText = `Studio: ${item.studios?.[0] || '-'}`;
            document.getElementById(`${prefix}Image`).src = item.image || DEFAULT_IMG;
        }

        function renderCharts() {
            // Decades
            const decades = {};
            library.forEach(i => { if (i.year) { const d = Math.floor(i.year / 10) * 10; decades[d] = (decades[d] || 0) + 1; }});
            new Chart(document.getElementById('decadeChart'), {
                type: 'bar',
                data: { labels: Object.keys(decades).sort().map(d => `${d}s`), datasets: [{ label: 'Titres', data: Object.keys(decades).sort().map(d => decades[d]), backgroundColor: '#8b5cf6', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
            });

            // Yearly
            const years = {};
            library.forEach(i => { if (i.year) years[i.year] = (years[i.year] || 0) + 1; });
            const sortedYears = Object.keys(years).sort().slice(-10);
            new Chart(document.getElementById('yearlyChart'), {
                type: 'line',
                data: { labels: sortedYears, datasets: [{ label: 'Titres', data: sortedYears.map(y => years[y]), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
            });

            // Top Downloads
            const topDownloads = [...library].sort((a, b) => b.local_files - a.local_files).slice(0, 10);
            new Chart(document.getElementById('topDownloadsChart'), {
                type: 'bar',
                data: { labels: topDownloads.map(d => d.title_en.substring(0, 20) + (d.title_en.length>20?'...':'')), datasets: [{ label: 'Fichiers', data: topDownloads.map(d => d.local_files), backgroundColor: '#8b5cf6', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
            });

            // Daily Activity
            const dailyMap = {};
            library.forEach(i => i.dates.forEach(d => dailyMap[d.date] = (dailyMap[d.date] || 0) + 1));
            const sortedDates = Object.keys(dailyMap).sort().slice(-30);
            new Chart(document.getElementById('dailyActivityChart'), {
                type: 'line',
                data: { labels: sortedDates, datasets: [{ label: 'Ajouts', data: sortedDates.map(d => dailyMap[d]), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
            });

            // Hourly
            const hourlyMap = {};
            library.forEach(i => i.dates.forEach(d => { const h = new Date(d.timestamp * 1000).getHours(); hourlyMap[h] = (hourlyMap[h] || 0) + 1; }));
            const hoursLabels = Array.from({ length: 24 }, (_, i) => i);
            new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: { labels: hoursLabels.map(h => `${h}h`), datasets: [{ label: 'Activité', data: hoursLabels.map(h => hourlyMap[h] || 0), backgroundColor: '#06b6d4', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
            });

            // Studios
            const studioStats = {};
            library.forEach(i => i.studios.forEach(s => { if (!studioStats[s]) studioStats[s] = 0; studioStats[s] += i.local_files; }));
            const topStudiosVol = Object.entries(studioStats).sort((a, b) => b[1] - a[1]).slice(0, 10);
            new Chart(document.getElementById('studioVolumeChart'), {
                type: 'bar',
                data: { labels: topStudiosVol.map(s => s[0]), datasets: [{ label: 'Volume', data: topStudiosVol.map(s => s[1]), backgroundColor: '#06b6d4', borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#1e293b' } }, y: { grid: { display: false } } } }
            });

            // Demographics
            const demos = {};
            library.forEach(i => { if (i.demographics.length > 0) i.demographics.forEach(d => demos[d] = (demos[d] || 0) + 1); else demos['Inconnu'] = (demos['Inconnu'] || 0) + 1; });
            new Chart(document.getElementById('demographicsChart'), {
                type: 'pie',
                data: { labels: Object.keys(demos), datasets: [{ data: Object.values(demos), backgroundColor: ['#ef4444', '#3b82f6', '#ec4899', '#f59e0b', '#64748b'], borderWidth: 0 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
            });

            // Source
            const sources = {};
            library.forEach(i => sources[i.source || 'Unknown'] = (sources[i.source || 'Unknown'] || 0) + 1);
            let cleanSources = { 'Manga': 0, 'Original': 0, 'Light Novel': 0, 'Autre': 0 };
            Object.entries(sources).forEach(([k, v]) => { if (cleanSources[k] !== undefined) cleanSources[k] += v; else cleanSources['Autre'] += v; });
            new Chart(document.getElementById('sourceChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(cleanSources), datasets: [{ data: Object.values(cleanSources), backgroundColor: ['#f59e0b', '#10b981', '#6366f1', '#475569'], borderWidth: 0 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
            });

            // Genre Radar
            const genreStats = {};
            library.forEach(i => i.genres.forEach(g => genreStats[g] = (genreStats[g] || 0) + 1));
            const topGenres = Object.entries(genreStats).sort((a, b) => b[1] - a[1]).slice(0, 7);
            new Chart(document.getElementById('genrePolarChart'), {
                type: 'radar',
                data: { labels: topGenres.map(g => g[0]), datasets: [{ label: 'Densité', data: topGenres.map(g => g[1]), backgroundColor: 'rgba(139, 92, 246, 0.2)', borderColor: '#8b5cf6', pointBackgroundColor: '#fff', pointBorderColor: '#8b5cf6', borderWidth: 2, fill: true }] },
                options: { maintainAspectRatio: false, scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, ticks: { display: false, backdropColor: 'transparent' }, pointLabels: { color: '#e2e8f0', font: { size: 12 } } } }, plugins: { legend: { display: false } } }
            });

            // Genre Files
            const genreFiles = {};
            library.forEach(i => i.genres.forEach(g => genreFiles[g] = (genreFiles[g] || 0) + i.local_files));
            const topGenreFiles = Object.entries(genreFiles).sort((a, b) => b[1] - a[1]).slice(0, 10);
            new Chart(document.getElementById('genreFilesChart'), {
                type: 'bar',
                data: { labels: topGenreFiles.map(g => g[0]), datasets: [{ label: 'Fichiers', data: topGenreFiles.map(g => g[1]), backgroundColor: '#ec4899', borderRadius: 4 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#1e293b' } }, y: { grid: { display: false } } } }
            });

            // Score Dist
            const scoreRanges = { '0-4': 0, '4-5': 0, '5-6': 0, '6-7': 0, '7-8': 0, '8-9': 0, '9-10': 0 };
            library.forEach(i => { const s = i.score || 0; if (s < 4) scoreRanges['0-4']++; else if (s < 5) scoreRanges['4-5']++; else if (s < 6) scoreRanges['5-6']++; else if (s < 7) scoreRanges['6-7']++; else if (s < 8) scoreRanges['7-8']++; else if (s < 9) scoreRanges['8-9']++; else scoreRanges['9-10']++; });
            new Chart(document.getElementById('scoreDistChart'), {
                type: 'bar',
                data: { labels: Object.keys(scoreRanges), datasets: [{ label: 'Titres', data: Object.values(scoreRanges), backgroundColor: '#fbbf24', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } } }
            });

            // Scatter
            new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: { datasets: [{ label: 'Titres', data: library.map(i => ({ x: i.local_files, y: i.score || 0, title: i.title_en })), backgroundColor: 'rgba(139, 92, 246, 0.7)', borderColor: '#8b5cf6', borderWidth: 1, pointRadius: 6, pointHoverRadius: 9 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { const item = context.raw; return `${item.title} (${item.y}★ | ${item.x} fichiers)`; } } } }, scales: { x: { title: { display: true, text: 'Volume', color: '#94a3b8' }, grid: { color: '#334155' } }, y: { title: { display: true, text: 'Note', color: '#94a3b8' }, grid: { color: '#334155' } } } }
            });
        }

        function renderTable(sortBy = 'files') {
            let sorted = [...library];
            if (sortBy === 'files') sorted.sort((a, b) => b.local_files - a.local_files);
            else if (sortBy === 'score') sorted.sort((a, b) => (b.score || 0) - (a.score || 0));
            else if (sortBy === 'year') sorted.sort((a, b) => (b.year || 0) - (a.year || 0));

            const tbody = document.getElementById('leaderboardBody'); 
            tbody.innerHTML = ''; 

            sorted.forEach((item, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-surface/50 hover:bg-surface/50 transition duration-150';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-center font-bold text-lg"><span class="${index < 3 ? 'text-gold' : 'text-gray-400'}">#${index + 1}</span></td>
                    <td class="px-6 py-4 font-medium text-white flex items-center space-x-3">
                        <div class="h-10 w-10 flex-shrink-0 overflow-hidden rounded-md bg-gray-700">
                            <img src="${item.image}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <a href="${item.url}" target="_blank" class="text-white font-medium truncate max-w-[250px] hover:text-primary transition hover:underline">${item.title_en}</a>
                            <p class="text-xs text-gray-400">${item.db_season_disp}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-xs text-gray-400">${item.year || '-'}</td>
                    <td class="px-6 py-4 text-xs text-accent">${item.studios?.[0] || '-'}</td>
                    <td class="px-6 py-4 text-xs text-gray-400">${item.genres?.slice(0, 2).join(', ') || '-'}</td>
                    <td class="px-6 py-4 text-right font-mono text-gray-300">${item.local_files}</td>
                    <td class="px-6 py-4 text-center font-bold"><span class="${item.score ? 'text-gold' : 'text-gray-600'}">${item.score ? item.score.toFixed(2) : '-'}</span></td>
                `;
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>